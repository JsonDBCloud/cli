# CI Design for @jsondb-cloud/cli

## Approach

Separate CI workflow (Approach 1) alongside existing `publish.yml`. CI runs on PRs + pushes to main. Publish stays untouched. Branch protection (manual GitHub config) enforces CI must pass before merge.

## CI Workflow

**File:** `.github/workflows/ci.yml`
**Triggers:** PRs to main, pushes to main
**Runner:** ubuntu-latest, Node 22

**Steps (single job):**
1. Checkout
2. Setup Node 22
3. `npm ci`
4. `npm run lint` (ESLint)
5. `npm run format:check` (Prettier, check-only)
6. `npm run typecheck` (`tsc --noEmit`)
7. `npm run build`
8. `npm test` (Vitest)

No matrix — single Node version, single OS.

## ESLint + Prettier

**ESLint:**
- Flat config (`eslint.config.js`)
- `@eslint/js` + `typescript-eslint`
- Recommended rulesets, no custom rules
- Target: `src/`

**Prettier:**
- `.prettierrc` with minimal config matching existing code style
- `.prettierignore` for `dist/`, `node_modules/`

**Scripts:**
- `lint`, `lint:fix`, `format`, `format:check`

**Dependencies:** `eslint`, `@eslint/js`, `typescript-eslint`, `prettier`

## Test Infrastructure

**Vitest:**
- `vitest.config.ts` at root
- Co-located test files: `src/**/*.test.ts`

**Unit tests:**
- `src/lib/config.test.ts` — config loading, env var precedence, credential parsing
- `src/lib/client.test.ts` — URL construction, headers, error handling
- `src/lib/output.test.ts` — table formatting, output modes

**Integration tests:**
- `src/commands/*.test.ts` — full command flow against mocked fetch
- Stub fetch with `vi.mock`, test CLI args -> handler -> API call -> formatted output

**Dependencies:** `vitest`
**Script:** `test` -> `vitest run`

## Non-Goals

- Modifying `publish.yml`
- Branch protection setup (manual GitHub config)
- E2E tests against real API
- Code coverage thresholds
- Node version matrix
- Pre-commit hooks
